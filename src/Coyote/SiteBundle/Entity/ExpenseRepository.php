<?php

namespace Coyote\SiteBundle\Entity;

use Doctrine\ORM\EntityRepository;

/**
 * ExpenseRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class ExpenseRepository extends EntityRepository
{
    public function findExpense($date, $id)
    {
        $query = $this->getEntityManager()
                        ->createQuery("
	            SELECT e FROM CoyoteSiteBundle:Expense e
	            WHERE e.date LIKE :key and e.userfees = :id"
                        );
        $query->setParameters(array('key' => '%'.$date.'%', 'id' => $id));
        //$query->setParameter('key', '%'.$date.'%');
        return $query->getResult();
    }
    
    public function updateStatus($em)
    {        
        $expense = $em->getRepository('CoyoteSiteBundle:Expense')->findAll();
        foreach($expense as $data)
        {
            $data->setStatus(0);
            $em->persist($data);
        }
        $em->flush();
        return "OK";
    }
    
    public function findforCompta()
    {
        $query = $this->getEntityManager()
                      ->createQuery("
                        SELECT e FROM CoyoteSiteBundle:Expense e
                        WHERE e.status = 1 ORDER BY e.userfees "
                        );
        $res = $query->getResult();
        
        $result = '';
        $userfees = '';
        foreach($res as $data)
        {
            if($data->getUserFees()->getLogin() != $userfees)
            {
                $userfees = $data->getUserFees()->getLogin();
                $result .= "\"H\";\"".$data->getUserFees()->getLogin()."\"\r\n";
            }
            $result .= "\"D\";";
            $result .= "\"".$data->getUserFees()->getLogin()."\";";//En majuscule
            $result .= "\"".$data->getSite()->getCode()."\";";
            $date = $data->getDate();
            $date = explode('/', $date);
            $result .= $date[0].$date[1].$date[2].";";// Enlever les /
            $result .= "\"".$data->getFee()->getCode()."\";";
            $result .= "\"".$data->getCurrency()->getCode()."\";";
            $result .= $data->getAmount().";";
            $result .= $data->getActualAmount().";";
            $result .= $data->getAmountTTC().";";
            $feeid = $data->getFee()->getCodeRate();
            $result .= "\"".$feeid."\";";
            $result .= $data->getAmountTVA().";";
            $result .= $data->getAmountTVA().";";
            $result .= "\"".$data->getUserFees()->getCode()."\";";
            $result .= "\"\";";
            $result .= "\"".$data->getBusiness()->getCode()."\";";
            $result .= "\"".$data->getUserFees()->getService()."\";";
            $result .= "\"".$data->getComment()."\";"."\r"."\n";
            
        }
        
        return $result;
    }
}
