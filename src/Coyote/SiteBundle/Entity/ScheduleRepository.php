<?php

namespace Coyote\SiteBundle\Entity;

use Coyote\SiteBundle\Entity\Timetable;
use Doctrine\ORM\EntityRepository;
use Doctrine\ORM\Tools\Pagination\Paginator;

/**
 * ScheduleRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class ScheduleRepository extends EntityRepository
{
    /***********************getScheduleUserAction**********************/

    /**
     * Function to synchronize id Timetable about a same id array time.
     * @param array $time Array data Schedule
     * @param array $data_timetable Array id Timetable
     * @return array $duration Array with absence duration Schedule
     */
    public function createIdTimetableSession($time, $data_timetable, $session)
    {
        $j = 0;
        $duration = array();
        for($i=0;$i<count($time);$i++)
        {
            if (count($time[$j])>0)
            {
                if ($data_timetable[$i]->getId() == $time[$j]->getTimetable()->getId())
                {
                    $session->set('id_'.$i, $time[$j]->getId());
                    $duration[$i] = $time[$j]->getAbsenceDuration();
                    $j++;
                }
            }
            else
            {
                $session->set('id_'.$i, '');
            }
        }
        return $duration;
    }

    /**
     * Function to find data about user and timetable.
     * @access public
     * @param Timetable $timetable
     * @param User $user
     * @return null if no data, else array with data schedule
     */
    public function findAllAboutTimetableUser($timetable, $user)
    {
        $index = 0;
        $time = null;
        foreach($timetable as $data)
        {
            $qb = $this->_em->createQueryBuilder();
            $qb->select('s')
               ->from('CoyoteSiteBundle:Schedule', 's')
               ->where('s.user = :user and s.timetable = :timetable')
               ->setParameters(array('user' => $user, 'timetable' => $data));
            $result = $qb->getQuery()->getOneOrNullResult();
            if($result == null)
                $time[$index] = array();
            else
                $time[$index] = $result;
            $index++;
        }
        return $time;
    }

    /******************weeklessAction**weekmoreAction******************/

    /**
     * Function to update week and period.
     * @access public
     * @param string $value "less" or "more"
     */
    public function updateWeek($value, $session)
    {
        $week = $session->get('week');
        $year = $session->get('year');
        if ($value == "less")
        {
            if ($week == 1)
            {
                $week = 53;
                $year--;
            }
            else
            {
                $week--;
            }
        }
        if ($value == "more")
        {
            if ($week == 53)
            {
                $week = 1;
                $year++;
            }
            else
            {
                $week++;
            }
        }
        $session->set('week', $week);
        $session->set('year', $year);
    }

    /**********************postScheduleUserAction**********************/

    /**
     * Function to save Schedule for technician user.
     * @access public
     * @param User $user
     * @param Timetable $timetable
     * @param string $time_start
     * @param string $time_end
     * @param string $time_break
     * @param boolean $time_travel
     * @param string $time_absence
     * @param float $time_absenceday
     * @param string $time_absencetime
     * @param string $time_comment
     * @return NULL if you don't need save entity else return entity Schedule
     */
    public function createSchedule($user, $timetable, $time_start, $time_end, $time_break, $time_travel, $time_absence,
            $time_absenceday, $time_absencetime, $time_comment)
    {
        if (empty($time_start) && empty($time_end) && empty($time_break) && empty($time_travel) && empty($time_comment)
                && ($time_absence == "Aucune"))
        {
            return null;
        }
        else
        {
            $schedule = new Schedule();
            $schedule->setUser($user);
            $schedule->setTimetable($timetable);
            if (empty($time_start))
                $time_start = '0:00';
            $schedule->setStart($time_start);
            if (empty($time_end))
                $time_end = '0:00';
            $schedule->setEnd($time_end);
            if (empty($time_break))
                $time_break = '0:00';
            $schedule->setBreak($time_break);
            $timetable = new Timetable();
            $working_time_day = $timetable->working_time_day($time_start, $time_end, $time_break);
            $schedule->setWorkingTime($working_time_day);
            $working_hours_day = $timetable->working_hours_day($working_time_day);
            $schedule->setWorkingHours($working_hours_day);
            if ($time_travel == "on")
                $time_travel = 1;
            else
                $time_travel = 0;
            $schedule->setTravel($time_travel);
            $schedule->setAbsenceName($time_absence);
            if ($time_absence == "Aucune")
            {
                $schedule->setAbsenceDuration("");
            }
            else
            {
                if ($time_absenceday == "0.5" || $time_absenceday == "1")
                    $schedule->setAbsenceDuration($time_absenceday);
                if ($time_absenceday == "empty")
                    $schedule->setAbsenceDuration($time_absencetime);
            }
            $schedule->setComment($time_comment);
            return $schedule;
        }
    }

    /**
     * Function to update Schedule for techician user.
     * @param Schedule $schedule
     * @param string $time_start
     * @param string $time_end
     * @param string $time_break
     * @param boolean $time_travel
     * @param string $time_absence
     * @param float $time_absenceday
     * @param string $time_absencetime
     * @param string $time_comment
     * @return Schedule
     */
    public function updateSchedule($schedule, $time_start, $time_end, $time_break, $time_travel, $time_absence,
            $time_absenceday, $time_absencetime, $time_comment)
    {
    	if ($schedule->getLocked() == 0)
    	{
	        $timetable = new Timetable();
	        if (empty($time_start))
	            $time_start = '0:00';
	        if (empty($time_end))
	            $time_end = '0:00';
	        if (empty($time_break))
	            $time_break = '0:00';
	        $schedule->setBreak($time_break);
	        $schedule->setStart($time_start);
	        $schedule->setEnd($time_end);
	        $schedule->setBreak($time_break);
	        $working_time_day = $timetable->working_time_day($time_start, $time_end, $time_break);
	        $schedule->setWorkingTime($working_time_day);
	        $working_hours_day = $timetable->working_hours_day($working_time_day);
	        $schedule->setWorkingHours($working_hours_day);
	        if ($time_travel == "on")
	            $time_travel = 1;
	        else
	            $time_travel = 0;
	        $schedule->setTravel($time_travel);
	        $schedule->setAbsenceName($time_absence);
	        if ($time_absence == "Aucune")
	        {
	            $schedule->setAbsenceDuration("");
	        }
	        else
	        {
	            if ($time_absenceday == "0.5" || $time_absenceday == "1")
	                $schedule->setAbsenceDuration($time_absenceday);
	            if ($time_absenceday == "empty")
	                $schedule->setAbsenceDuration($time_absencetime);
	        }
	        $schedule->setComment($time_comment);
	        return $schedule;
    	}
    }

    /**
     * Function to save Schedule for framework user.
     * @access public
     * @param User $user
     * @param Timetable $timetable
     * @param boolean $time_travel
     * @param string $time_absence
     * @param float $time_absenceday
     * @param string $time_absencetime
     * @param string $time_comment
     * @param float $day
     * @return NULL if you don't need save entity else return entity Schedule
     */
    public function createSchedulefm($user, $timetable, $time_travel, $time_absence, $time_absenceday,
            $time_absencetime, $time_comment, $day)
    {
        if ($day == "empty" && empty($time_travel) && empty($time_comment)
                && ($time_absence == "Aucune"))
        {
            return null;
        }
        else
        {
            $schedule = new Schedule();
            $schedule->setUser($user);
            $schedule->setTimetable($timetable);
            $schedule->setStart("0:00");
            $schedule->setEnd("0:00");
            $schedule->setBreak("0:00");
            $schedule->setWorkingTime("0:00");
            $schedule->setWorkingHours($day);
            if ($time_travel == "on")
                $time_travel = 1;
            else
                $time_travel = 0;
            $schedule->setTravel($time_travel);
            $schedule->setAbsenceName($time_absence);
            if ($time_absenceday == "0.5" || $time_absenceday == "1")
                $schedule->setAbsenceDuration($time_absenceday);
            if ($time_absenceday == "empty")
            {
                if ($time_absencetime == "undef")
                    $schedule->setAbsenceDuration('');
                else
                    $schedule->setAbsenceDuration($time_absencetime);
            }
            if ($time_absence == "Aucune")
            {
            	$schedule->setAbsenceDuration('');
            }
            $schedule->setComment($time_comment);
            return $schedule;
        }
    }

    /**
     * Function to update Schedule for framework user.
     * @access public
     * @param Schedule $schedule
     * @param boolean $time_travel
     * @param string $time_absence
     * @param float $time_absenceday
     * @param string $time_absencetime
     * @param string $time_comment
     * @param float $day
     * @return Schedule
     */
    public function updateSchedulefm($schedule, $time_travel, $time_absence, $time_absenceday, $time_absencetime,
            $time_comment, $day)
    {
        $schedule->setWorkingHours($day);
        if ($time_travel == "on")
            $time_travel = 1;
        else
            $time_travel = 0;
        $schedule->setTravel($time_travel);
        $schedule->setAbsenceName($time_absence);
        if($time_absenceday == "0.5" || $time_absenceday == "1")
            $schedule->setAbsenceDuration($time_absenceday);
        if ($time_absenceday == "empty")
        {
            if($time_absencetime == "undef")
                $schedule->setAbsenceDuration('');
            else
                $schedule->setAbsenceDuration($time_absencetime);
        }
        if ($time_absence == "Aucune")
        {
        	$schedule->setAbsenceDuration('');
        }
        $schedule->setComment($time_comment);
        return $schedule;
    }

    /*************************getScheduleAction************************/

    /**
     * Function to find period about month and year.
     * @param string $month
     * @param string $year
     * @return string $period
     */
    public function findPeriod($month, $year)
    {
        $period = "";
        if ($month >= "01" && $month <= "05")
        {
            $previous_year = $year - 1;
            $period = $previous_year."/".$year;
        }
        if ($month >= "06" && $month <= "12")
        {
            $following_year = $year + 1;
            $period = $year."/".$following_year;
        }
        return $period;
    }

    /**
     * Function to count number absence.
     * @access public
     * @param datetime $date
     * @param User $user
     * @param string $absence
     * @return number
     */
    public function countAbsenceMonth($date, $user, $absence)
    {
        $qb = $this->_em->createQueryBuilder();
        $qb->select('s.absence_duration')
           ->from('CoyoteSiteBundle:Schedule', 's')
           ->innerJoin('CoyoteSiteBundle:Timetable', 't', 'WITH', 't.id = s.timetable')
           ->where('s.user = :user and t.date LIKE :date and s.absence_name = :absence')
           ->setParameters(array('user' => $user, 'date' => $date, 'absence' => $absence));
        $data_absence_duration = $qb->getQuery()
                                    ->getResult();
        $count_absence = 0.0;
        for($i = 0; $i<count($data_absence_duration);$i++)
        {
            $count_absence += $data_absence_duration[$i]['absence_duration'];
        }
        return $count_absence;
    }

    /**
     * Function to count number absence about a period by user and specific absence.
     * @access public
     * @param string $period
     * @param User $user
     * @param string $absence
     * @return number
     */
    public function findAbsenceYear($period, $user, $absence)
    {
        $qb = $this->_em->createQueryBuilder();
        $qb->select('s.absence_duration')
           ->from('CoyoteSiteBundle:Schedule', 's')
           ->innerJoin('CoyoteSiteBundle:Timetable', 't', 'WITH', 't.id = s.timetable')
           ->where('s.user = :user and t.period = :period and s.absence_name = :absence')
           ->setParameters(array('user' => $user, 'period' => $period, 'absence' => $absence));
        $data_absence_duration = $qb->getQuery()
                                    ->getResult();
        $count_absence = 0.0;
        for($i = 0; $i<count($data_absence_duration);$i++)
        {
            $count_absence += $data_absence_duration[$i]['absence_duration'];
        }
        return $count_absence;
    }

    /**
     * Function to count working hours in month.
     * @access public
     * @param string $date
     * @param User $user
     * @return float
     */
    public function findDayMonth($date, $user)
    {
        $qb = $this->_em->createQueryBuilder();
        $qb->select('s.working_hours')
        ->from('CoyoteSiteBundle:Timetable', 't')
        ->innerJoin('CoyoteSiteBundle:Schedule', 's', 'WITH', 't.id = s.timetable')
        ->where('t.date LIKE :date and s.user = :user')
        ->setParameters(array('date' => $date, 'user' => $user));
        $data_working_hours = $qb->getQuery()
        ->getResult();
        $working_day = 0.0;
        foreach($data_working_hours as $value)
        {
            $working_day = $working_day + $value['working_hours'];
        }
        return $working_day;
    }

    /**
     * Function to count working hours in period.
     * @access public
     * @param mixed $period
     * @param mixed $user
     * @return number
     */
    public function findDayYear($period, $user)
    {
        $qb = $this->_em->createQueryBuilder();
        $qb->select('s.working_hours')
           ->from('CoyoteSiteBundle:Timetable', 't')
           ->innerJoin('CoyoteSiteBundle:Schedule', 's', 'WITH', 't.id = s.timetable')
           ->where('t.period = :period and s.user = :user')
           ->setParameters(array('period' => $period, 'user' => $user));
        $data_working_hours = $qb->getQuery()
                                 ->getResult();
        $working_day = 0.0;
        foreach($data_working_hours as $value)
        {
            $working_day = $working_day + $value['working_hours'];
        }
        return $working_day;
    }

    /**
     * Function to calculate working time by week.
     * @access public
     * @param Schedule $dataschedule
     * @return string $timeweek if $dataschedule is empty $timeweek = ''
     * else $timeweek is string format 'hh:mm'
     */
    public function countTimeWeek($dataschedule)
    {
        if(count($dataschedule)>0)
        {
            $week = $dataschedule[0]['date']->format('W');
            $index = 0;
            $value = 0;
            $timeweek = '';
            $count_item = count($dataschedule)-1;
            for($i=0;$i<count($dataschedule);$i++)
            {
                if ($week == $dataschedule[$i]['date']->format('W'))
                {
                    $value += $this->convertTimeinMinutes($dataschedule[$i]['working_time']);
                    $week = $dataschedule[$i]['date']->format('W');
                }
                if ($count_item == $i)
                {
                    $timeweek[$index] = $this->createFormatTime($value);
                    $value=0;
                    $index++;
                    $value += $this->convertTimeinMinutes($dataschedule[$i]['working_time']);
                    $timeweek[$index] = $this->createFormatTime($value);
                }
                if ($week != $dataschedule[$i]['date']->format('W'))
                {
                    $timeweek[$index] = $this->createFormatTime($value);
                    $value=0;
                    $index++;
                    $value += $this->convertTimeinMinutes($dataschedule[$i]['working_time']);
                    $week = $dataschedule[$i]['date']->format('W');
                }
            }
        }
        else
        {
            $timeweek = '';
        }
        return $timeweek;
    }

    /**
     * Function to count working time by month.
     * @access public
     * @param string $date
     * @param User $user
     * @return string total working time
     */
    public function findTimeMonth($date, $user)
    {
        $qb = $this->_em->createQueryBuilder();
        $qb->select('s.working_time')
           ->from('CoyoteSiteBundle:Schedule', 's')
           ->innerJoin('CoyoteSiteBundle:Timetable', 't', 'WITH', 't.id = s.timetable')
           ->where('s.user = :user and t.date LIKE :date')
           ->setParameters(array('user' => $user, 'date' => $date));
        $workingtime_schedule =  $qb->getQuery()
                                    ->getResult();
        $timeend = "0";
        for($i = 0; $i<count($workingtime_schedule); $i++)
        {
            $timeend += $this->convertTimeinMinutes($workingtime_schedule[$i]['working_time']);
        }
        $time = $this->createFormatTime($timeend);
        return $time;
    }

    /**
     * Function to find data schedule for technician user by month.
     * @access public
     * @param User $user
     * @param string $date
     * @return Schedule
     */
    public function findAboutDateUser($user, $date)
    {
        $date = $date."%";
        $qb = $this->_em->createQueryBuilder();
        $qb->select('t.date, s.start, s.end, s.break, s.working_time, s.working_hours, s.travel, s.absence_name,
            s.absence_duration, s.comment , t.holiday')
           ->from('CoyoteSiteBundle:Timetable', 't')
           ->innerJoin('CoyoteSiteBundle:Schedule', 's', 'WITH', 't.id = s.timetable')
           ->where('t.date LIKE :date and s.user = :user ')
           ->orderBy('s.timetable')
           ->setParameters(array('date' => $date, 'user' => $user, ));
        $dataschedule =  $qb->getQuery()
                            ->getResult();
        return $dataschedule;
    }

    /**
     * Function to find data schedule for framework user by month.
     * @access public
     * @param User $user
     * @param string $date
     * @return Schedule
     */
    public function findAboutDateUserFM($user, $date)
    {
        $qb = $this->_em->createQueryBuilder();
        $qb->select('t.date, s.working_hours, s.travel, s.absence_name, s.absence_duration, s.comment,
            t.holiday')
           ->from('CoyoteSiteBundle:Timetable', 't')
           ->innerJoin('CoyoteSiteBundle:Schedule', 's', 'WITH', 't.id = s.timetable')
           ->where('t.date LIKE :date and s.user = :user')
           ->orderBy('s.timetable')
           ->setParameters(array('date' => $date, 'user' => $user));
        $dataschedule =  $qb->getQuery()
                            ->getResult();
        return $dataschedule;
    }

    /************************Absence:indexAction***********************/

    /**
     * Get the paginated list of absences in Schedule Entity.
     *
     * @param int $page
     * @param int $maxperpage
     * @param string $sortby
     * @return Paginator
     */
    public function getListAbsenceUser($user, $page=1, $maxperpage=10)
    {
        $q = $this->_em->createQueryBuilder()
                  ->select('s')
                  ->from('CoyoteSiteBundle:Schedule','s')
                  ->where('s.user = :user and not s.absence_name =:absence')
                  ->orderBy('s.timetable', 'DESC')
                  ->setParameters(array('user' => $user, 'absence' => 'Aucune' ));

        $q->setFirstResult(($page-1) * $maxperpage)
          ->setMaxResults($maxperpage);
        return new Paginator($q);
    }

    /**
     * Function to find absence by User.
     * @param User $user
     * @return Schedule $entities
     */
    public function findAllByUserAbsence($user)
    {
        $qb = $this->_em->createQueryBuilder();
        $qb->select('s')
            ->from('CoyoteSiteBundle:Schedule', 's')
            ->where('s.user = :user and not s.absence_name = :absence')
            ->orderBy('s.timetable', 'ASC')
            ->setParameters(array(
                        'user' => $user,
                        'absence'  => 'Aucune',
        ));
        $entities = $qb->getQuery()->getResult();
        return $entities;
    }

    /*******************Admin:exportDataUserAction******************/

    /**
     * Function to retrieve data user about a date.
     * @param User $user
     * @param string $date date format 'Y-m-%'
     * @return Schedule Entity
     */
    public function findAboutUserBE($user, $date)
    {
        $qb = $this->_em->createQueryBuilder();
        $qb->select('t.date, s.start, s.end, s.break, s.working_time, s.working_hours, s.comment,
            s.travel, s.absence_name, s.absence_duration')
                ->from('CoyoteSiteBundle:Timetable', 't')
                ->innerJoin('CoyoteSiteBundle:Schedule', 's', 'WITH', 't.id = s.timetable')
                ->where('t.date LIKE :date and s.user = :user')
                ->setParameters(array('date' => $date, 'user' => $user));
        $timetableschedule = $qb->getQuery()->getResult();
        return $timetableschedule;
    }

    /**
     * Function to generate file for Chef_BE with data users.
     * @param array $tab_user_id Id User who work to Chef_BE
     * @param string $month
     * @param string $year
     * @return string data users
     */
    public function createFileUserBE($tab_user_id, $month, $year)
    {
        $result = "";
        $week = 0;
        foreach($tab_user_id as $user_id)
        {
            $timetableschedule = $this->findAboutUserBE($user_id, $year.'-'.$month.'-%');
            $timeres = 0;
            $user_name = $this->findNameUser($user_id);
            $result .= $user_name[0]['name'].";\r\n\r\n";
            foreach($timetableschedule as $data)
            {
                if($week != 0 && $data['date']->format('W') != $week)
                {
                    $result .= "Temps de travail de la semaine : ".$this->createFormatTime($timeres).";\r\n\r\n";
                    $timeres = 0;
                }
                $week = $data['date']->format('W');
                $result .= $data['date']->format('l').';'.$data['date']->format('Y-m-d').';';
                $result .= $data['start'].";".$data['end'].";".$data['break'].";".$data['working_time'].";";
                $result .= $data['working_hours'].";";
                $result .= $data['travel'].";".$data['absence_name'].";".$data['absence_duration'].";";
                $result .= $data['comment'].";\r\n";
                $timeres += $this->convertTimeinMinutes($data['working_time']).";\r\n";
                if ($data === end($timetableschedule))
                {
                    $result .= "Temps de travail de la semaine : ".$this->createFormatTime($timeres).";\r\n\r\n";
                    $timeres = 0;
                }
            }
        }
        return $result;
    }
    
    /**
     * nameUser function.
     *
     * @access public
     * @param mixed $user
     * @return string
     */
    public function findNameUser($user)
    {
    	$qb = $this->_em->createQueryBuilder();
    	$qb->select('u.name')
    	   ->from('CoyoteSiteBundle:User', 'u')
    	   ->where('u.id = :user')
    	   ->setParameters(array('user' => $user));
    	$user_name = $qb->getQuery()->getResult();
    	return $user_name;
    }

    /*****************************Commun****************************/

    /**
     * Function to convert time in minutes.
     * @access public
     * @param string $time
     * @return number integer minutes
     */
    private function convertTimeinMinutes($time)
    {
        if ($time == "0:00")
            return 0;
        $time = explode(":", $time);
        $minute = $time[1];
        $heure = $time[0];
        $timefinal = $heure * 60 + $minute;
        return $timefinal;
    }

    /**
     * Function to convert time in hours.
     *
     * @access public
     * @param mixed $time
     * @return string format hh:mm
     */
    private function createFormatTime($time)
    {
        date_default_timezone_set('UTC');
        $time = $time * 60;
        $heures=intval($time / 3600);
        $minutes=intval(($time % 3600) / 60);
        if (strlen($minutes) < 2)
        {
            $minutes = '0'.$minutes;
        }
        return $heures.'h'.$minutes;
    }

    /**********************putAbsenceWeekAction*********************/

    /**
     * Function to save absence into Schedule entity.
     * @param string $date_start
     * @param string $date_end
     * @param User $user
     * @param array $data
     * @return number Number schedule save
     */
    public function putAbsenceWeek($date_start, $date_end, $user, $data)
    {
        $date_start = new \DateTime($date_start);
        $date_end = new \DateTime($date_end);

        $qb = $this->_em->createQueryBuilder();
        $qb->select('t')
           ->from('CoyoteSiteBundle:Timetable', 't')
           ->where('t.date between :date_start and :date_end')
           ->setParameters(array(
                        'date_start' => $date_start->format('Y-m-d'),
                        'date_end' => $date_end->format('Y-m-d')));
        $timetables = $qb->getQuery()->getResult();
        $countsave = 0;
        for($i=0; $i<count($timetables);$i++)
        {
	        $qb = $this->_em->createQueryBuilder();
	        $timetable = $timetables[$i];
	        if (($timetable->getDate()->format('l') != "Sunday") and ($timetable->getDate()->format('l') != "Saturday"))
	        {
	        $countsave++;
	        $qb->select('s')
        	   ->from('CoyoteSiteBundle:Schedule', 's')
        	   ->where('s.user = :user and s.timetable = :timetable')
               ->setParameters(array('user' => $user,
                                     'timetable' => $timetable));
                $schedule = $qb->getQuery()->getOneOrNullResult();
                if ($schedule == null)
                {
	                $schedule = new Schedule();
	                $schedule->setUser($user);
	                $schedule->setStart('0:00');
	                $schedule->setBreak('0:00');
	                $schedule->setEnd('0:00');
	                $schedule->setWorkingTime('0:00');
	                $schedule->setWorkingHours('0');
	                $schedule->setTimetable($timetable);
	                $schedule->setAbsenceName($data['absence_name']);
                	$schedule->setAbsenceDuration($data['absence_duration']);
	                if (isset($data['travel']))
	                {
	                	$schedule->setTravel($data['travel']);
	                }
                    else
                    {
                        $schedule->setTravel('0');
                	}
                	$schedule->setComment($data['comment']);
                    $this->_em->persist($schedule);
                }
                else
                {
                	$schedule->setStart('0:00');
                    $schedule->setBreak('0:00');
                    $schedule->setEnd('0:00');
                    $schedule->setWorkingTime('0:00');
                    $schedule->setWorkingHours('0');
                    $schedule->setAbsenceName($data['absence_name']);
                    $schedule->setAbsenceDuration($data['absence_duration']);
                    if (isset($data['travel']))
                    {
                        $schedule->setTravel($data['travel']);
                    }
                    else
                    {
                    	$schedule->setTravel('0');
                    }
                    $schedule->setComment($data['comment']);
        			$this->_em->persist($schedule);
                }
	        }
            $qb = null;
        }
        $this->_em->flush();
        return $countsave;
    }

    /********************postScheduleLockedAction*******************/

        /**
         * Function to lock Schedule
         * @param DateTime $date
         */
        public function postScheduleLocked($date, $user)
        {
        	$qb = $this->_em->createQueryBuilder();
        	$qb->select('s')
        	   ->from('CoyoteSiteBundle:Schedule', 's')
        	   ->innerJoin('CoyoteSiteBundle:Timetable', 't', 'WITH', 't.id = s.timetable')
        	   ->where('t.date < :date and s.locked != 1')
        	   ->setParameters(array('date' => $date));
        	$schedules = $qb->getQuery()->getResult();
        	foreach($schedules as $schedule)
        	{
        		$schedule->setLocked(1);
        		$schedule->setLockedAt(new \DateTime());
        		$schedule->setLockedBy($user->getName());
        		$this->_em->persist($schedule);
        	}
        	$this->_em->flush();
        	return "OK";
        }
        
        public function createFileUser($user, $date_start, $date_end)
        {
        	$qb = $this->_em->createQueryBuilder();
        	$qb->select('t.date, s.start, s.end, s.break, s.working_time, s.working_hours, s.comment,
            s.travel, s.absence_name, s.absence_duration')
                    ->from('CoyoteSiteBundle:Timetable', 't')
                    ->innerJoin('CoyoteSiteBundle:Schedule', 's', 'WITH', 't.id = s.timetable')
                    ->where('s.user = :user and t.date BETWEEN :date_start and :date_end')
                    ->orderBy('s.timetable')
                    ->setParameters(array('date_start' => $date_start, 'date_end' => $date_end, 'user' => $user));
        	$timetableschedule = $qb->getQuery()->getResult();
        	$result = "Jour;Date;Debut;Fin;Pause;Temps de travail;Jour travaille;Déplacement;Absence;Duree de l'absence;Commentaire;\r\n";
        	$week = 0;
        	$timeres = 0;
        	foreach($timetableschedule as $data)
        	{
        		if($week != 0 && $data['date']->format('W') != $week)
        		{
        			$result .= "Temps de travail de la semaine :;;;".$this->createFormatTime($timeres).";\r\n\r\n";
        			$timeres = 0;
        		}
        		$week = $data['date']->format('W');
        		$result .= $data['date']->format('l').';'.$data['date']->format('Y-m-d').';';
        		$result .= $data['start'].";".$data['end'].";".$data['break'].";".$data['working_time'].";";
        		$result .= $data['working_hours'].";";
        		$result .= $data['travel'].";".$data['absence_name'].";".$data['absence_duration'].";".$data['comment'].";\r\n";
        		$timeres += $this->convertTimeinMinutes($data['working_time']).";\r\n";
        		if ($data === end($timetableschedule))
        		{
        			$result .= "Temps de travail de la semaine :;;;".$this->createFormatTime($timeres).";\r\n\r\n";
        			$timeres = 0;
        		}
        	}
        	return $result;
        }

    /******************************************************************/
    /***********************Fonctions en cours*************************/
    /******************************************************************/

    public function countOvertime($user, $working_time_week)
    {
    	$query = $this->_em->createQuery(
    			"SELECT s FROM CoyoteSiteBundle:Schedule s WHERE s.timetable IN
    			(SELECT t.id FROM CoyoteSiteBundle:Timetable t WHERE
    			 DAYOFWEEK(t.date) != 1 and DAYOFWEEK(t.date) != 7 and t.holiday = 0)
    			and s.user = :user and s.comment != :comment and s.absence_duration != 1")
    				->setParameters(array(
    			'user' => $user,
    			//'period'  => '2014/2015',
    			'comment' => 'IMIE'
    	));

    	$schedules = $query->getResult();
    	$res = 0;
    	foreach($schedules as $data)
    	{
    		$workingtime = $data->getWorkingTime();
    		$res += $this->convertTimeinMinutes($workingtime);
    	}
    	$hour = 7;
    	if ($working_time_week != 0)
    		$hour = $working_time_week / 5;
    	$time = count($schedules)*$hour*60;
    	$hs = $res - $time;
		return $this->createFormatTime($hs);
    }

    /******************************************************************/
    /***********************Anciennes Fonctions************************/
    /******************************************************************/

}